<!DOCTYPE html>
<meta charset="utf-8">
<style>
    /* set the CSS */
    .line {
        fill: none;
        stroke-width: 2px;
    }

    .first_wrapper .line {
        stroke: steelblue;
    }

    .first_wrapper .area {
        fill: lightsteelblue;
    }

    .axis line,
    .axis path.domain {
        display: none;
    }

    #city_selector_wrapper,
    #buttons_wrapper {
        display: inline-block;
        margin: 30px;
    }

    select {
        padding: 10px 8px;
        border-radius: 3px;
        margin-left: 15px;
    }

    .hide {
        display: none;
    }

    .g_wra_2 .y.axis text,
    .g_wra_1 .y.axis text,
    .g_wra_3 .y.axis text {
        display: none;
    }

    #buttons_wrapper a {
        text-decoration: none;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        background: #748907;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        margin-left: 10px;
    }
</style>

<body>
    <div id="city_selector_wrapper">
        <label> Select City </label>
        <select id="city_selector">
    <option select value="De-Panne">De Panne</option>
    <option value="Koksijde">Koksijde</option>
    <option value="Nieuwpoort">Nieuwpoort</option>
    <option value="Veurne">Veurne</option>
  </select>
    </div>
    <div id="buttons_wrapper">
        <a href="#" id="show1stchart" onClick="show1stchart();"> Show Total </a>
        <a href="#" id="show2ndchart" onClick="show2ndchart();"> Show Types </a>
        <a href="#" id="show3rdchart" onClick="show3rdchart();"> Show Seperate </a>
    </div>

    <div id="chart1"></div>
    <div id="chart2"></div>
    <div id="chart3"></div>
    <!-- load the d3.js library -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
      // set the dimensions and margins of the graph
      var margin = {top: 20,right: 20,bottom: 30,left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

        var y = d3.scaleLinear().range([height, 0]).nice();

        // append the svg obgect to the body of the page
        // appends a 'group' element to 'svg'
        // moves the 'group' element to the top left margin
        var svg = d3.select("#chart1").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // set the ranges
            var x = d3.scaleTime().range([0, width]).nice();
        
        //define the area
        var firstchartarea = d3.area().x(function(d) {
                    return x(d.date);
                })
                .y0(height)
                .y1(function(d) {
                    return y(d.close);
                });
        var area = d3.area().x(function(d) {
                    return x(d.data.date);
                })
                .y0(function(d) {
                    return y(d[0]);
                })
                .y1(function(d) {
                    return y(d[1]);
                });

        var area1 = d3.area()
                .x(function(d) {
                    return x(d['date']);
                })
                .y0(function(d) {
                    return y(d[0]);
                })
                .y1(function(d) {
                    return y(d[1]);
                });

        // define the line
        var valueline = d3.line()
                .x(function(d) {
                    return x(d.date);
                })
                .y(function(d) {
                    return y(d.close);
                })
                .curve(d3.curveCardinal);

        function drawfirstChart() {                                  
            // get the data
            var jsonfileName = jQuery("#city_selector").val();
            jsonfileName += ".json";
            d3.json(jsonfileName, function(data) {
                var keysArray = Object.keys(data);
                var newdata = [];
                var newzerodata = [];
                for (var i = 0; i < keysArray.length; i++) {
                    var tmpData = {};
                    tmpData['key'] = keysArray[i];
                    tmpData['value'] = d3.sum(Object.values(data[keysArray[i]]));
                    newdata.push(tmpData);

                    var zeroData = {};
                    zeroData['date'] = Date.parse(keysArray[i]);
                    zeroData['close'] = 0;
                    newzerodata.push(zeroData);
                }

                // format the data
                newdata.forEach(function(d) {
                    d.date = Date.parse(d.key);
                    d.close = +d.value;
                });
                

                // scale the range of the data
                x.domain(d3.extent(newdata, function(d) {
                    return d.date;
                })).nice();
                y.domain([0, d3.max(newdata, function(d) {
                    return d.close;
                })]).nice();

                var first_wrapper = svg.append('g').attr('class','first_wrapper');
                // add the area  
                first_wrapper.append("path")
                    .data([newdata])
                    .attr("class", "area")
                    .attr("d", firstchartarea)
                    .transition()
                    .duration(1500)
                    .attrTween('d', function() {
                        var interpolator = d3.interpolate(newzerodata, newdata)
                        return function(t) {
                            return firstchartarea(interpolator(t));
                        }
                    });


                // add the valueline path.
                first_wrapper.append("path")
                    .data([newdata])
                    .attr("class", "line")
                    .attr("d", valueline)
                    .transition()
                    .duration(1500)
                    .attrTween('d', function() {
                        var interpolator = d3.interpolate(newzerodata, newdata)
                        return function(t) {
                            return valueline(interpolator(t));
                        }
                    });

                // add the X Axis
                first_wrapper.append("g").attr('class', 'x axis')
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat("%Y")));

                // add the Y Axis
                first_wrapper.append("g").attr('class', 'y axis')
                    .call(d3.axisLeft(y).ticks(4));

            });
        }

        function draw2ndChart() {
            var data = [];
            var tsvData = null;        

            var x = d3.scaleTime().range([0, width]).nice();
            

            var color = d3.scaleOrdinal(d3.schemeCategory20);

            var xAxis = d3.axisBottom()
                .scale(x).ticks(5);

            var yAxis = d3.axisLeft()
                .scale(y).ticks(5);

            var stack = d3.stack()
            var zerostack = d3.stack()

            var jsonfileName = jQuery("#city_selector").val();
            jsonfileName += ".json";
            d3.json(jsonfileName, function(error, jsondata) {
                // d3.json('De-Panne.json', function(error, jsondata) {
                for (var key in jsondata) {
                    var tmp_array = new Object;
                    // skip loop if the property is from prototype
                    if (!jsondata.hasOwnProperty(key)) continue;
                    tmp_array.date = key;
                    var obj = jsondata[key];
                    for (var prop in obj) {
                        // skip loop if the property is from prototype
                        if (!obj.hasOwnProperty(prop)) continue;
                        tmp_array[prop] = obj[prop];
                    }
                    data.push(tmp_array);
                }

                color.domain(d3.keys(data[0]).filter(function(key) {
                    return key !== 'date';
                }));

                var keys = d3.keys(data[0]).filter(function(key) {
                    return key !== 'date';
                })
                data.forEach(function(d) {
                    d.date = Date.parse(d.date);
                });
                tsvData = (function() {
                    return data;
                })();


                var maxDateVal = d3.max(data, function(d) {
                    var vals = d3.keys(d).map(function(key) {
                        return key !== 'date' ? d[key] : 0
                    });
                    return d3.sum(vals);
                });

                // Set domains for axes
                x.domain(d3.extent(data, function(d) {
                    return d.date;
                })).nice();
                y.domain([0, maxDateVal]).nice();

                stack.keys(keys);

                stack.order(d3.stackOrderNone);
                stack.offset(d3.stackOffsetNone);

                zerostack.keys(keys);
                zerostack.order(d3.stackOrderNone);
                zerostack.offset(d3.stackOffsetNone);
                var zeroArray = [];
                for (var i = 0; i < zerostack(data).length; i++) {
                    var zerosub = [];
                    for (var j = 0; j < zerostack(data)[i].length; j++) {
                        var tmp_a = {};
                        tmp_a[0] = zerostack(data)[i][j][0];
                        tmp_a[1] = zerostack(data)[i][j][0];
                        tmp_a['date'] = zerostack(data)[i][j]['data']['date'];
                        zerosub.push(tmp_a);
                    }
                    zeroArray.push(zerosub);
                }

                var second_wrapper = svg.append('g').attr('class','second_wrapper');
                var browser = second_wrapper.selectAll('.browser')
                    .data(stack(data))
                    .enter().append('g')
                    .attr('class', function(d) {
                        return 'browser ' + d.key;
                    })
                    .attr('fill-opacity', 0.5);

                browser.append('path')
                    .attr('class', 'area')
                    .style('fill', function(d) {
                        return color(d.key);
                    })
                    .transition()
                    .delay(function(d, i) {
                        return i * 1000;
                    })
                    .duration(1000)
                    .attrTween('d', function(d, i) {
                        var ba = [];
                        for (var j = 0; j < d.length; j++) {
                            var tmp_a = {};
                            tmp_a[0] = d[j][0];
                            tmp_a[1] = d[j][1];
                            tmp_a['date'] = d[j]['data']['date'];
                            ba.push(tmp_a);
                        }
                        var interpolator = d3.interpolate(zeroArray[i], ba);
                        return function(t) {
                            return area1(interpolator(t));
                        }
                    });

                browser.append('text')
                    .datum(function(d) {
                        return d;
                    })
                    .attr('transform', function(d) {
                        return 'translate(' + (width / 2) + ',' + (y(d[13][1]) + 80) + ')';
                    })
                    .attr('x', -6)
                    .attr('dy', '.35em')
                    .style("text-anchor", "middle")
                    .text(function(d) {
                        return d.key;
                    })
                    .attr('fill-opacity', 1);
            });
        }

        function draw3rdChart() {

            var color = d3.scaleOrdinal(d3.schemeCategory20c);
            // parse the date / time
            // var parseTime = d3.timeParse("%d-%b-%y");

            // set the ranges
            var x = d3.scaleTime().range([0, (width / 4 - 50)]).nice();            

            // define the area
            // var area = d3.area()
            //     .x(function(d) {
            //         return x(d.date);
            //     })
            //     .y0(height)
            //     .y1(function(d) {
            //         return y(d.close);
            //     });

            // // define the line
            // var valueline = d3.line()
            //     .x(function(d) {
            //         return x(d.date);
            //     })
            //     .y(function(d) {
            //         return y(d.close);
            //     });

            // get the data
            // d3.csv("data.csv", function(error, data) {
            var jsonfileName = jQuery("#city_selector").val();
            jsonfileName += "2.json";
            d3.json(jsonfileName, function(jsondata) {
                var keysArray = Object.keys(jsondata);
                var jsondataArray = Object.entries(jsondata).map(([key, value]) => ({
                    key,
                    value
                }));
                jsondataArray = Object.entries(jsondataArray).map(([key, value]) => ({
                    key,
                    value
                }));

                jsondataArray.forEach(function(d) {
                    d.close = +d3.max(Object.values(d.value.value));
                });

                y.domain([0, d3.max(jsondataArray, function(d) {
                    return d.close;
                })]).nice();

                for (var i = 0; i < keysArray.length; i++) {
                    var tmpKey = keysArray[i];
                    var data = jsondata[tmpKey];

                    data = Object.entries(data).map(([key, value]) => ({
                        key,
                        value
                    }));
                    // format the data
                    data.forEach(function(d) {
                        d.date = Date.parse(d.key);
                        d.close = +d.value;
                    });
                    x.domain(d3.extent(data, function(d) {
                        return d.date;
                    })).nice();

                    var zeroData = [];
                    data.forEach(function(d) {
                        var tmpzero = {};
                        tmpzero['date'] = Date.parse(d.key);
                        tmpzero['close'] = 0;
                        zeroData.push(tmpzero);
                    })

                    // var parseTime = d3.timeParse("%Y");

                    // scale the range of the data
                    var third_wrapper = svg.append('g').attr('class','third_wrapper');
                    var g_wrapper = third_wrapper.append('g').attr('class', 'g_wrapper g_wra_' + i).attr('transform', "translate(" + (i * width / 4) + ',0)');
                    // add the area
                    g_wrapper.append("path")
                        .data([data])
                        .attr("class", "area")
                        .attr('fill', color(4 * i + 1))
                        .attr("d", firstchartarea)
                        .transition()
                        .duration(1500)
                        .attrTween('d', function(d) {
                            var interpolator = d3.interpolate(zeroData, d)
                            return function(t) {
                                return area(interpolator(t));
                            }
                        });

                    // add the valueline path.
                    g_wrapper.append("path")
                        .data([data])
                        .attr("class", "line")
                        .attr('stroke', color(4 * i + 3))
                        .attr("d", valueline)
                        .transition()
                        .duration(1500)
                        .attrTween('d', function(d) {
                            var interpolator = d3.interpolate(zeroData, d)
                            return function(t) {
                                return valueline(interpolator(t));
                            }
                        });;

                    // add the X Axis
                    g_wrapper.append("g").attr('class', 'x axis')
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x).ticks(4).tickFormat(d3.timeFormat("%Y")));

                    // add the Y Axis
                    g_wrapper.append("g").attr('class', 'y axis')
                        .call(d3.axisLeft(y).ticks(5));

                    // g_wrapper.append("text").attr('x',0).attr('y',-70).attr('dy','.3em').text(tmpKey); 

                    var g_indi_start = g_wrapper.append('g').attr('class', 'indicator_start');
                    g_indi_start.append('rect')
                        .attr('class', 'indi_rect indirect_' + i)
                        .attr('x', (x(data[0].date) - 20))
                        .attr('y', (y(data[0].close) - 15))
                        .attr('width', 40)
                        .attr('height', 30)
                        .attr('fill', 'white')

                    g_indi_start.append('text').attr('x', (x(data[0].date))).attr('y', (y(data[0].close))).attr('dy', '.3em').text(data[0].close).attr('text-anchor', 'middle').attr('fill', 'white');

                    var g_indi_end = g_wrapper.append('g')
                        .attr('class', 'indicator_end');
                    g_indi_end.append('rect')
                        .attr('class', 'indi_rect indirect_' + i)
                        .attr('x', (x(data[data.length - 1].date) - 20))
                        .attr('y', (y(data[data.length - 1].close) - 15))
                        .attr('width', 40)
                        .attr('height', 30)
                        .attr('fill', 'white');
                    g_indi_end.append('text').attr('x', (x(data[data.length - 1].date))).attr('y', (y(data[data.length - 1].close))).attr('dy', '.3em').text(data[data.length - 1].close).attr('text-anchor', 'middle').attr('fill', 'white');
                }
                svg.selectAll('rect.indi_rect')
                    .transition()
                    .style('fill', function(d, i) {
                        var className = d3.select(this).attr('class');
                        var t = className[19];
                        return color(4 * t + 3);
                    })
                    .duration(2500)
            });

        }
        $(function() {
            drawfirstChart();
            draw2ndChart();
            // draw3rdChart();
            // $('#city_selector').change(function() {
            //     $("#chart1").empty();
            //     drawfirstChart();
            // })
        })

        function show2ndchart() {            
          transition2ndChart();                     
        }

        function show3rdchart() {            
            transition3rdChart();            
        }

        function show1stchart() {                        
            transition1stChart();            
        }

        function transition2ndChart(){

        }
        function transition3rdChart(){

        }

        function transition1stChart(){

        }
    </script>
</body>